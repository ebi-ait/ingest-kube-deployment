stages:
  - deploy

deploy_ingest:
  stage: deploy
  tags:
    ingest-kube-deployment
  script:
    - >
      if [[ "$ENV" =~ ^(dev|integration|staging|prod)$ ]]; then
        echo "Deploying on $ENV"
        kubectl config set-context ingest-eks-$ENV
        source config/environment_$ENV
        cd apps
        for APP in ${APPS}; do make deploy-app-${APP}; done
      fi
  when: manual